.. sectionauthor:: Дмитрий Барышников <dmitry.baryshnikov@nextgis.ru>

.. _ngcourse_q2w:

Публикация проекта QGIS в сервисе nextgis.com
=================================================

В рамках этой части курса будет сформирован проект в :program:`NextGIS QGIS` и
опубликован в облачном сервисе `nextgis.com <https://my.nextgis.com>`_.

Подготовительный этап
--------------------------------------

На подготовительном этапе осуществим подключение Веб ГИС к NextGIS QGIS.
У вас должна уже быть учетная запись в nextgis.com и создана своя Веб ГИС.

Для подключения Веб ГИС к NextGIS QGIS выполним следующие шаги:

1. В интернет браузере выполним переход к своей Веб ГИС (URL вида
   http://``<имя при регистрации>``.nextgis.com).

   .. figure:: img/ngw_main.png
      :name: ngcourse_ngw1_pic
      :align: center
      :width: 18cm

      Главное окно Веб ГИС.

2. Выполним вход в Веб ГИС с правами администратора. Для этого, справа вверху
   нажимаем кнопку "Войти". В качестве имени вводим ``administrator`` с соблюдением
   регистра, пароль должен был быть доставлен на электронную почту. При успешном
   входе, в шапке Веб ГИС появляется "Панель управления".
3. Далее подключим свою Веб ГИС к NextGIS QGIS. Для этого, запустим NextGIS QGIS.
4. После запуска NextGIS QGIS установим модуль расширения NextGIS Connect. В случае
   если модуль уже установлен, проверим его версию и обновим.
5. При помощи меню ``Модули ‣ Управление модулями...`` откроем диалог управления
   модулями (см. :numref:`ngcourse_ngq_plugins_pic`).

   .. figure:: img/ngq_plugins.png
      :name: ngcourse_ngq_plugins_pic
      :align: center
      :width: 12cm

      Диалог управления модулями.

   В поле "Поиск" введем NextGIS Connect.
6. Если модуль не установлен - выбираем "установить", если установлен и активирован
   (отмечен флажком), то выбираем "обновить" (если кнопка неактивна, то установлена
   актуальная версия модуля). После установки или обновления закрываем диалог.
7. Далее запустим модуль **NextGIS Connect** и выполним его первоначальную настройку.
   В меню ``Модули ‣ NextGIS Connect ‣ Показать/Скрыть панель NextGIS Connect`` отмечаем
   флажок. При этом должна появится панель модуля (см. :numref:`ngcourse_ngq_connect_pic` ).
   Панель можно открыть и при помощи кнопки на панели инструментов в виде ``Х``.

   .. figure:: img/ngq_nqconnect.png
      :name: ngcourse_ngq_connect_pic
      :align: center
      :width: 8cm

      Панель модуля NextGIS Connect.

8. Нажмите кнопку "Настройки" (в виде шестеренки) на панели модуля NextGIS Connect.
   В открывшемся окне (см. :numref:`ngcourse_ngq_ngconn1_pic`) нажмите кнопку
   "Новое" cнимите галку "Как гость" и заполните поля:

   * URL - адрес своей Веб ГИС (URL вида http://``<имя при регистрации>``.nextgis.com).
   * Имя - идентификатор подключения для быстрого поиска в списке подключений.

   .. figure:: img/ngq_nqconnect_settings.png
      :name: ngcourse_ngq_ngconn1_pic
      :align: center
      :width: 12cm

      Диалог создания нового подключения.

   Нажмите кнопку "ОК".
9. Проверим настройки модуля. Необходимо отметить флажки у пунктов
   ``Переименовывать запрещенные поля`` и ``Исправлять некорректные геометрии``.
   Остальные флажки нужно снять (внешний вид диалога см. :numref:`ngcourse_ngq_ngconn2_pic`).

   .. figure:: img/ngq_ngconnect_settings.png
      :name: ngcourse_ngq_ngconn2_pic
      :align: center
      :width: 8cm

      Диалог настроек модуля.

10. После закрытия диалога в панели модуля будет отображено содержимое вашей Веб
    ГИС. Для вновь созданной Веб ГИС там будет только одна пустая веб карта.

Создание проекта в NextGIS QGIS
-----------------------------------------------

На предыдущем этапе мы подготовили связку настольной и Веб ГИС. Теперь создадим
проект (карту) и настроим ее внешний вид.

1. Для удобства подключим картографическую подложку (базовую карту). Для этого,
   установим модуль расширения **QuickMapServices**. В случае если модуль уже
   установлен, проверим его версию и обновим.
2. При помощи меню ``Модули ‣ Управление модулями...`` откроем диалог управления
   модулями (см. :numref:`ngcourse_ngq_plugins_pic`). В поле "Поиск" введем
   "QuickMapServices".
3. Если модуль не установлен - выбираем "установить", если установлен и активирован
   (отмечен флажком), то выбираем "обновить" (если кнопка неактивна, то установлена
   актуальная версия модуля). После установки или обновления закрываем диалог.
4. Откроем панель QuickMapServices через пункт меню
   ``Web ‣ QuickMapServices ‣ Поиск в QMS`` и в поле поиска введем фразу "Mapnik"
   (см. :numref:`ngcourse_ngq_qms1_pic`).

   .. figure:: img/ngq_qms_mapnik.png
      :name: ngcourse_ngq_qms1_pic
      :align: center
      :width: 8cm

      Панель поиска картографических подложек.

   Нажмем кнопку "Добавить". В результате на карту должна добавиться
   картографическая подложка `OpenStreetMap <http://www.openstreetmap.org>`_.
5. Скачаем границы федеральных округов России. Для этого в панели QuickMapServices
   наберем фразу "границы". В списке найденного выберем "Federal districts of Russia".

   .. tip::
      Подробнее с составом и описанием геоданных в сервисе QuickMapServices можно
      ознакомится по `ссылке <https://qms.nextgis.com>`_. В частности, геоданные
      с федеральными округами доступны по следующей
      `ссылке <https://qms.nextgis.com/geoservices/553/>`_. К данной странице можно
      перейти прямо из панели QuickMapServices нажав кнопку "подробнее".

6. Добавим границы на карту. Нажмем кнопку "Добавить". В результате на карту
   должны добавиться границы федеральных округов (см. :numref:`ngcourse_ngq_fed_districts_pic`).

   .. figure:: img/ngq_fed_districts.png
      :name: ngcourse_ngq_fed_districts_pic
      :align: center
      :width: 18cm

      Карта федеральных округов с таблицей атрибутов.

7. Посмотрим какие есть атрибуты у данного слоя . Для этого, вызовем контекстное
   меню слоя в дереве слоев и выберем пункт ``Открыть таблицу атрибутов``.
   Таблицу атрибутов, выделенного в дереве слоев, слоя можно открыть и при помощи
   кнопки на панели инструментов. В результате внизу окна должна появится
   табличка с атрибутвами слоя (см. :numref:`ngcourse_ngq_fed_districts_pic`).
   Как видно из атрибутов имеется только название федерального округа.
8. Обогатим эти данные. Перейдем к странице `Федеральные округа Российской Федерации <https://ru.wikipedia.org/wiki/%D0%A4%D0%B5%D0%B4%D0%B5%D1%80%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5_%D0%BE%D0%BA%D1%80%D1%83%D0%B3%D0%B0_%D0%A0%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B9_%D0%A4%D0%B5%D0%B4%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8>`_ в Википедии.
   В таблице данных по округам имеется дополнительная информация:

   * Население (чел.) 2017
   * Количество субъектов РФ
   * Административный центр
   * Естественный прирост, убыль населения в ‰ (за 2016 год)
   * ВРП в млрд руб. (за 2015 год)

   Скопируем эти данные в электронную таблицу (Excel, Calc, и т.п.) и сохраним
   в формате :term:`CSV` и именем ``fed_districts.csv``. Также можно скачать файл
   по данной :download:`ссылке <files/fed_districts.csv>`.
9. Откроем таблицу в NextGIS QGIS. Вызовем ``Слой ‣ Добавить слой ‣ Добавить векторный слой...``
   и в открывшемся диалоге выберем таблицу, далее нажмем кнопку "Открыть". Таблица
   должна появится в дереве слоев.

   Откроем ее для просмотра. Для этого, вызовем контекстное меню слоя в дереве
   слоев и выберем пункт ``Открыть таблицу атрибутов``.
   В результате окно NextGIS QGIS должно выглядеть следующим образом: см.
   :numref:`ngcourse_ngq_fed_districts1_pic`.

   .. figure:: img/ngq_fed_districts1.png
      :name: ngcourse_ngq_fed_districts1_pic
      :align: center
      :width: 18cm

      Карта федеральных округов с таблицей дополнительных атрибутов.

10. Соединим слой федеральных округов "Federal districts of Russia" и таблицу
    "fed_districts". Для этого вызовем контекстное меню слоя "Federal districts of Russia"
    и выберем пункт ``Свойства``. В диалоге свойств слоя перейдем на вкладку "Связи".
    Нажмем кнопку ``+`` и в открывшемся диалоге (см.
    :numref:`ngcourse_ngq_link_settings_pic`) укажем:

    * Связанный слой ``fed_districts``
    * Поле для объединения ``name``
    * Целевое поле ``name``

    Остальные настройки оставим по-умолчанию.

    .. figure:: img/ngq_link_settings.png
       :name: ngcourse_ngq_link_settings_pic
       :align: center
       :width: 12cm

       Диалог настройки связей.

    Нажмем кнопку "ОК". В результате в окне настройки связей появится новая запись
    (см. :numref:`ngcourse_ngq_links_pic`).

    .. figure:: img/ngq_links.png
       :name: ngcourse_ngq_links_pic
       :align: center
       :width: 12cm

       Настройки связей в диалоге своств слоя.

    В результате в таблице атрибутов слоя "Federal districts of Russia" добавятся
    новые атрибуты из таблицы "fed_districts" (см.
    :numref:`ngcourse_ngq_linked_attributes_pic`).

    .. figure:: img/ngq_linked_attributes.png
       :name: ngcourse_ngq_linked_attributes_pic
       :align: center
       :width: 16cm

       Таблица атрибутов слоя "Federal districts of Russia".

11. Сохраним результат соединения под новым именем в формате :term:`GeoJSON`. Вызовем
    контекстное меню слоя ``Сохранить как...``. В диалоге выберем (см.
    :numref:`ngcourse_ngq_save_as_pic`):

    * Формат ``GeoJSON``
    * Имя файла ``fed_districts.geojson``
    * Система координат ``EPSG:4326 - WGS 84``
    * Поставить флажок ``Добавить слой в проект``

    .. figure:: img/ngq_save_as.png
       :name: ngcourse_ngq_save_as_pic
       :align: center
       :width: 14cm

       Диалог сохранения слоя.

    Нажмем "ОК". В результате в на карту добавится новый слой "fed_districts".
    Удалим из дерева слоев таблицу "fed_districts" и слой "Federal districts of Russia",
    для этого последовательно на каждом слое в дереве слоев вызовем конткестное
    меню и выберем в нем пункт ``Удалить``. В результате на карте должны остаться
    только 2 слоя: "fed_districts" и "OpenStreetMap Standard aka Mapnik".

    Переименуем слой "fed_districts" в ""Федеральные округа". Для этого, вызовем
    контекстное меню слоя "fed_districts" и выберем в нем пункт ``Переименовать``.
    В поле ввода введем "Федеральные округа".
12. Преобразуем текстовые значения поля ``fed_districts_pop_change`` в цифровые
    при помощи калькулятора поля. Для этого, в таблице атрибутов слоя нажимаем на
    соответствующую кнопку панели инструментов (см.
    :numref:`ngcourse_ngq_linked_attributes_pic` вторая справа).

    В диалоге вводим следующие параметры (см. :numref:`ngcourse_ngq_add_field_pic`):

    * Отметим флажок ``Создать новое поле``
    * Имя поля ``pop_change_num``
    * Тип ``Десятичное число (real)``
    * Размер ``20``
    * Точность ``10``
    * Выражение ``"fed_districts_pop_change"``

    .. figure:: img/ngq_add_new_field.png
       :name: ngcourse_ngq_add_field_pic
       :align: center
       :width: 14cm

       Диалог калькулятора поля.

    После нажатия "ОК" в таблице атрибутов добавится новое поле с именем ``pop_change_num``.
    При этом будет активирован режим редактирования. Завершим режим редактирования,
    вызвав контекстное меню слоя и выбрав пункт ``Режим редактирования``. На запрос
    сохранения правок (см. :numref:`ngcourse_ngq_save_warning_pic`) отвечаем
    утвердительно.

    .. figure:: img/ngq_save_warning.png
       :name: ngcourse_ngq_save_warning_pic
       :align: center
       :width: 8cm

       Запрос на сохранение правок.

13. Настроем стиль отображения слоя "Федеральные округа". Вызовем контекстное
    меню слоя и выберем пункт ``Свойства``. В диалоге свойств слоя перейдем на
    вкладку "Стиль". На вкладке "Стиль" введем следующие параметры
    (см. :numref:`ngcourse_ngq_set_style_pic`):

    * Стиль ``Градуированный знак``
    * Поле ``pop_change_num``
    * Градиент от синего до красного
    * Классов ``7``

    .. figure:: img/ngq_style_settings.png
       :name: ngcourse_ngq_set_style_pic
       :align: center
       :width: 12cm

       Вкладка "Стиль" диалога свойств слоя.

    Нажмем кнопку "Классифицировать".

    Перейдем на вкладку "Подписи" и введем следующие параметры
    (см. :numref:`ngcourse_ngq_set_labels_pic`):

    * Подписи ``Показывать подписи для этого слоя``
    * Подписывать значениями ``name``
    * Размер (текста) ``11.0000``

    .. figure:: img/ngq_label_settings.png
       :name: ngcourse_ngq_set_labels_pic
       :align: center
       :width: 12cm

       Вкладка "Подписи" диалога свойств слоя.

    В результате должна получится следующая карта (см. :numref:`ngcourse_ngq_map_pic`).

    .. figure:: img/ngq_map.png
       :name: ngcourse_ngq_map_pic
       :align: center
       :width: 18cm

       Карта федеральных округов.

    На карте показаны прирост/убыль населения в виде градиента от красного и до
    синего цвета. Чем цвет ближе к красному, тем больше прирост населения, к
    синему - убыль.

Публикация интерактивной веб карты
-----------------------------------------------

На предыдущем этапе мы создали карту в настольном приложении NextGIS QGIS. Теперь
опубликуем эту карту в вашей Веб ГИС на сервисе nextgis.com.

1. Сохраним файл проекта при помощи меню ``Проекты ‣ Сохранить как...``. В диалоге
   сохранения укажем путь и имя файла проекта ``fed_districts``.
2. В панели плагина ``NextGIS Connect`` вызовем меню кнопки "Добавить в Веб ГИС"
   и выберем пункт ``Импортировать текущий проект``
   (см. :numref:`ngcourse_ngqc_import_menu_pic`).

   .. figure:: img/ngqc_import_menu.png
      :name: ngcourse_ngqc_import_menu_pic
      :align: center
      :width: 8cm

      Меню кнопки "Добавить в Веб ГИС".

   В открывшемся диалоге зададим имя "Федеральные округа". После нажатия кнопки
   "ОК" будет открыта новая веб карта (см.
   :numref:`ngcourse_ngw_fed_districts_pic`).

   .. figure:: img/ngw_fed_districts.png
      :name: ngcourse_ngw_fed_districts_pic
      :align: center
      :width: 18cm

      Веб карта федеральных округов.

   Полученную карту можно внедрить в свою веб страницу, для этого перейдем на
   вкладку "Поделиться" (см. :numref:`ngcourse_ngw_share_webmap_pic`).

   .. figure:: img/ngw_share_webmap.png
      :name: ngcourse_ngw_share_webmap_pic
      :align: center
      :width: 18cm

      Веб карта федеральных округов в режиме формирования ссылки для внедрения в
      свою веб страницу.
