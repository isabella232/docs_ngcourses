.. sectionauthor:: Артём Светлов <artem.svetlov@nextgis.ru>

.. _ngcourse_rasters_intro:

Введение
========

Настоящий курс предназначен для начинающих пользователей и охватывает различные
аспекты работы с растровыми слоями в NextGIS QGIS

Работа с цифровыми моделями рельефа
======================================
Работа с растровыми стилями на примере ЦМР.
Учебные данные: 1 сцена SRTM, 1 сцена ASTER DEM, берутся на http://earthexplorer.usgs.gov

1. Зайти на http://earthexplorer.usgs.gov. Указать место, наборы данных SRTM Void filled, ASTR GLOBAL DEM.
2. Нажать на кнопку footprint и preview, посмотреть как рисуется охват и превью.
3. Кинуть в NextGIS QGIS два файла из учебных данных. Сделать активным SRTM.
4. Пощёлкать инструментом идентификации, показать что он пишет метры.
5. Открыть свойства. Показать гистограмму, то что в ней 1 канал, и значения изменяются не от 0 до 255, а в метрах.
6. Зайти в стиль --> Одноканальное псевдоцветное. Раскрыть "Значения мин/макс". Нажать кнопку "Загрузить значения", выбрать палитру, нажать "обратить". Ок. На карте рельеф покрасится.
7. Скопировать стиль из SRTM в ASTER, повключать его. На экране будет видно, что у ASTER более детальное пространственное и вертикальное разрешение.
8. Поставить плагин MapSwipe Tool и поездить (забыл как называется).
9. Переместить карту на какой-нибудь лес или овраг, 1x1 км. Свойства слоя --> Стиль --> Значения мин/макс --> Clip Extent to Canvas. На экране будет видно, что в этом фрагменте карты цвета стали более контрастными, и более видны переходы в этом месте. 
10. Стили - переключить interpolation между линейная и дискретная. На экране будет видно, что перепады высот станут более выраженными.
11. Дублировать стиль, Стили --> Hillshade, прозрачность=80 (подогнать под видимость на проекторе). На экране будет видно, что станет ещё выраженнее.



Рассказать теорию: в принципе ещё бывают ЦММ, детальные ЦМР можно получить с коптеров, их используют археологи. С топокарт всё намного детальнее чем в ASTER

Обрезка по маске
================================
Учебные данные: файл - раст с коптера или landsat, с чёрными краями по углам.
Исходная документация: https://www.gdal.org/gdalwarp.html

Растр можно обрезать по охвату, а можно по маске - по векторному полигону.
Векторный слой должен быть в той же системе координат что и растр. В маске могут быть дырки и части. Эта операция полезна например если у вас есть ортофотоплан с квадрокоптера, полученный в стороннем софте, а по краям у него - чёрные или белые области, которые всё загораживают.

1. Откроем подложку, растр, увеличим до слоя. На его краях - чёрные области, карту под ним не видно. 
2. Если растр открывается медленно, то сделайте пирамиды: свойства слоя --> пирамиды. Настройки: Формат пирамид - внешние, метод интерполяции - кубическая. Выделить уровни в списке справа. Нажать на кнопку "Создать пирамиды". Через несколько минут на диске создастся файл .ovr, а показ растра не будет тормозить.
3. Проверим систему координат растра: свойства слоя.

4. Создадим маску. Новый временный слой, мультиполигональный, система координат - как у растра. Нарисуйте фигуру. Можно нарисовать мультиполигон. Из векторного слоя будет использована только первая фича.
5. Запустите обрезку через processing: GDAL/OGR --> Извлечение --> Обрезать растр по маске. Настройки: Создать альфа-канал, охват целевого слоя по линии обрезки. Тип целевого слоя = битности исходного растра. Тип сжатия = JPEG. Обрезка идёт несколько минут.

Ньюанс: через меню растр растровые инструменты работают только с файлами, не со всеми векторными слоями

6. Посмотрим получившийся растр. У него нет пирамид, поэтому он грузится долго. В гистограмме видно, что у него добавился новый канал - альфа-канал.

Интерполяция
================================
В этом блоке мы возьмём точки, интерполируем их, и сделаем растр с плавным изменением значений.
Учебные данные: файл - точечный слой с числовым значением - средний чек в кофейнях.
Исходная документация: https://www.gdal.org/gdal_grid.html

1. Откроем файл из учебных данных. Увеличить до слоя. 
2. Откроем таблицу атрибутов. В слое есть числовой параметр.
3. Растр --> Анализ --> Интерполяция. Настройки: слой (так исторически сложилось, что инструмент работает только с файлами некоторых форматов, а не временными слоями, https://github.com/nextgis/nextgisqgis/issues/66), Z-поле - , больше ничего. Этот инструмент почему-то не работает через processing, и из консоли запускать его приятнее.
4. Через несколько минут создастся растровый слой. зайдём в его свойства --> Гистограмма. Этот слой будет одноканальный, на гистограмме виден диапазон значений в его пикселах. Сейчас можно кликнуть в каждое значение на карте, и посмотреть его. 
5. Покрасим его так, что бы было нагляднее. Свойства слоя --> Стиль. Одноканальное псевдоцветное. [Написать здесь значения]. Прозрачность = 50

Покажем возможность обратного перехода от растра к вектору.

1. На карте должен быть слой полученный на прошлом этапе - одноканальный растр с плавно изменяющимися значениями.
2. Растр --> Polygonize (растр в вектор). Настройки: имя поля - включено. Через несколько секунд у вас появися полигональный слой. Каждый полигон - это 1 пиксел изображения. Соседние полигоны будут слиты.
3. Настроим векторный стиль, так что бы было видно значения. Слой --> Подписи. Поле для подписей будет DN, или как вы назвали его при создании растра. 
4. Настроим векторный стиль, так что бы этот результат был более наглядным. Слой --> Стиль. Градуированый знак. В настройках знака сделайте прозрачную линию обводки. Интерполяция - дискретная.



Провайдеры бесплатных снимков
================================

1. http://earthexplorer.usgs.gov/
2. https://astrodigital.com/
3. https://libra.developmentseed.org/
4. https://docs.opendata.aws/landsat-pds/readme.html
5. http://sentinel-pds.s3-website.eu-central-1.amazonaws.com/

vrt
========
Учебные данные: 4 снимка LandsatLook с геопривязкой на одном меридиане. 

1. Взять из примера 4 снимка LandsatLook с геопривязкой.
2. Открыть в QGIS.
3. Растр --> Дополнительные --> Построить виртуальный растр. 
4. Source No data = 0
5. На экране будет видно, что несколько растров берутся из одного файла.
6. Открыть файл в блокноте, показать что там внутри ссылки на файлы.
7. Показать адрес страницы документации - https://www.gdal.org/gdal_vrttut.html
